<template>
  <div v-loading="loading">
    <div class="home3-2__top">
      <button class="left-arrow" :disabled="selectedPeriod.period === 1" @click="handleAddPeriod(-1)">
      </button>
      <div class="home3-2__top__a">
        <span class="tih">{{ selectedPeriod.period }}주차</span><br>
        <span class="tiha">{{ getPeriodDateText() }}</span>
      </div>
      <button class="right-arrow" :disabled="selectedPeriod.period === formData.length" @click="handleAddPeriod(1)">
      </button>
    </div>

    <div class="home3-2__mid">
      <p class="ti">
        <img src="~@/assets/images/exclamation.png" class="exclamation" alt="">
        원하시는 제품의 수량을 선택해주세요
      </p>
    </div>
    <div class="home3-2__bot pd-bot">
      <ul>
        <li
          v-for="(item, index) in selectedPeriod.items"
          :key="index"
          class="home3-2__list"
        >
          <div class="img__wrap">
            <div class="imgg">
              <img src="~@/assets/images/rice.png" alt="">
            </div>
            <div class="img__black" v-if="item.amount < 1">
            </div>
          </div>
          <div class="home3-2__box">
            <el-input-number v-model="item.amount" @change="handleChange" :min="0" :max="14"></el-input-number>
            <p class="ti color2">{{ item.name }}</p>
						<div class="material">
							<div class="price">5000원</div>

              <el-popover v-if="item.material.length > 50"
                placement="middle-start"
                :width="300"
                trigger="click"
                :content=item.material
              >
                <template #reference>
                 <p class="tti">
                  {{ item.material.substring(0,50) }} ... <b>더보기</b>
                  </p>
                  <!-- <el-button class="m-2">Hover to activate</el-button> -->
                </template>
              </el-popover>
              <p v-else class="tti">
                  {{ item.material }}
              </p>
						</div>
          </div>
        </li>
      </ul>
    </div>
    <div style="position:relative; width:100%;">
      <div class="home3-1__bot fix-bot">
				<div class="total-amount-wr">
					<div class="total-amount">
						<p>총 개수</p>
						<p>n 개</p>
					</div>
					<div class="total-amount">
						<p>총 결제금액</p>
						<p>n 원</p>
					</div>
				</div>
        <div class="home3-1__bot__a a">
          <a style="cursor: pointer;" class="diet_next_button" @click="handleOrder()">맞춤식단 결제하기</a>
          <a style="cursor: pointer;" class="diet_next_button2" @click="handleOrder2()">데모 결제하기</a>
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import moment from 'moment';
import { getItemsList } from '@/api/items';
// import { addCustomDietOrder } from '@/api/customDiet';
import { parseDate } from '@/filters/index';

export default {
  data() {
    return {
      loading: true,
      itemsQuery: {
        dietType: 0,
        dietPurpose: 0,
        dietPrecaution: 0,
        numOfMeals: 0,
        pickUpDay: 0,
        period: 0,
        dayOfWeek: 1,
      },
      items: [],
      formData: [],
      selectedPeriod: {
        period: 0,
        items: [],
      },
    };
  },
  methods: {
    handleChange(value: any, oldValue: any) {
      const maxMeals: = Number(this.$route.query.numOfMeals);
      let totalAmount = 0;
      this.selectedPeriod.items.forEach((item: any) => {
        totalAmount += item.amount;
      });
      if (maxMeals < totalAmount) {
        this.$notify.warning({
          title: `주 당 식사 수는 ${maxMeals}개입니다.`,
          message: '선택하신 식사 수량이 초과되었습니다. 수량을 조정해주세요.',
        });
      }
    },
    setForm() {
      const period = Number(this.$route.query.period);
      const dayNum = Number(this.$route.query.dayOfWeek);
      for (let i = 0; i < period; i += 1) {
        (this.formData as any).push({
          period: i + 1,
          items: [],
        });
      }
      this.selectedPeriod = this.formData[0];
    },
    getItems() {
      getItemsList(this.itemsQuery).then((res) => {
        this.loading = false;
        this.items = res.data;
        const period = Number(this.$route.query.period);
        for (let i = 0; i < period; i += 1) {
          res.data.forEach((item: any) => {
            (this.formData[i] as any).items.push({
              ...item,
              amount: 0,
            });
          });
        }
      });
    },
    handleAddPeriod(num: number) {
      let index = this.selectedPeriod.period - 1;
      index += num;
      this.selectedPeriod = this.formData[index];
    },
    getPeriodDateText() {
      const baseDate = moment().day(7);
      const index = this.selectedPeriod.period - 1;
      const startDate = baseDate.add(index * 7, 'days').format('YYYY년 MM월 DD일');
      const endDate = baseDate.add(index * 7 + 6, 'days').format('MM월 DD일');
      return `${startDate} ~ ${endDate}`;
    },
    handleOrder() {
      /* eslint-disable */
      const maxMeals = Number(this.$route.query.numOfMeals);
      this.formData.forEach((data: any) => {
        let totalAmount = 0;
        data.items.forEach((item: any) => {
          totalAmount += item.amount;
        });
        if (maxMeals < totalAmount) {
          this.$notify.warning({
            title: `주 당 식사 수는 ${maxMeals}개입니다.`,
            message: `${data.period}주차에 선택하신 식사 수량이 초과되었습니다. 수량을 조정해주세요.`,
          });
          return false;
        }
      });
      /* eslint-enable */
      const data: any = {
        ...this.itemsQuery,
        items: this.formData,
      };
     /*  addCustomDietOrder(data).then((res) => {
        this.$router.push({ name: 'Pay', query: { dietId: res.data } });
      }); */
    },
    handleOrder2() {
      /* eslint-disable */
      const maxMeals = Number(this.$route.query.numOfMeals);
      this.formData.forEach((data: any) => {
        let totalAmount = 0;
        data.items.forEach((item: any) => {
          totalAmount += item.amount;
        });
        if (maxMeals < totalAmount) {
          this.$notify.warning({
            title: `주 당 식사 수는 ${maxMeals}개입니다.`,
            message: `${data.period}주차에 선택하신 식사 수량이 초과되었습니다. 수량을 조정해주세요.`,
          });
          return false;
        }
      });
      /* eslint-enable */
      const data: any = {
        ...this.itemsQuery,
        items: this.formData,
      };
      this.$router.push({ name: 'Pay2', query: { dietId: data } });
    },
  },
  created() {
    this.itemsQuery = {
      ...this.itemsQuery,
      ...this.$route.query,
    };
  },
  mounted() {
    this.setForm();
    this.getItems();
  },
};
</script>
